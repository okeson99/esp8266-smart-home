/*
  Day 3: DHT22 Temperature & Humidity Sensor
  Board: NodeMCU 1.0 (ESP-12E Module)
  Sensor: DHT22 on GPIO4 (D2)
*/

#include <ESP8266WiFi.h>
#include <ESP8266WebServer.h>
#include <DHT.h>

// WiFi credentials
const char* ssid = "Okaro¬£";
const char* password = "";

// DHT setup
#define DHTPIN 4        // GPIO4 = D2
#define DHTTYPE DHT11   // DHT22 sensor
DHT dht(DHTPIN, DHTTYPE);

ESP8266WebServer server(80);
const int LED = LED_BUILTIN;

unsigned long lastRead = 0;
float temperature = 0;
float humidity = 0;

void setup() {
  Serial.begin(115200);
  pinMode(LED, OUTPUT);
  digitalWrite(LED, HIGH);
  
  delay(1000);
  Serial.println("\nESP8266 Smart Home - Day 3");
  
  // Initialize DHT
  dht.begin();
  Serial.println("DHT22 sensor initialized");
  
  // Connect WiFi
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nConnected!");
  Serial.print("IP: ");
  Serial.println(WiFi.localIP());
  
  // Server routes
  server.on("/", handleRoot);
  server.on("/data", handleData);      // JSON API
  server.on("/on", handleOn);
  server.on("/off", handleOff);
  server.begin();
  
  Serial.println("Server ready");
}

void loop() {
  server.handleClient();
  
  // Read sensor every 2 seconds
  if (millis() - lastRead > 2000) {
    readSensor();
    lastRead = millis();
  }
}

void readSensor() {
  float newTemp = dht.readTemperature();
  float newHum = dht.readHumidity();
  
  if (isnan(newTemp) || isnan(newHum)) {
    Serial.println("Failed to read from DHT sensor!");
    return;
  }
  
  temperature = newTemp;
  humidity = newHum;
  
  Serial.print("Temp: ");
  Serial.print(temperature);
  Serial.print("¬∞C  Humidity: ");
  Serial.print(humidity);
  Serial.println("%");
}

void handleRoot() {
  String html = "<!DOCTYPE html><html><head>";
  html += "<meta http-equiv='refresh' content='3'>";  // Auto-refresh every 3 sec
  html += "<style>";
  html += "body{font-family:Arial;margin:40px;background:#f0f0f0;}";
  html += ".card{background:white;padding:20px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.1);margin-bottom:20px;}";
  html += ".reading{font-size:48px;font-weight:bold;color:#333;}";
  html += ".label{color:#666;font-size:14px;text-transform:uppercase;}";
  html += "button{padding:15px 30px;margin:5px;border:none;border-radius:5px;cursor:pointer;font-size:16px;}";
  html += ".on{background:#4CAF50;color:white;}";
  html += ".off{background:#f44336;color:white;}";
  html += "</style></head><body>";
  
  html += "<div class='card'>";
  html += "<h1>üè† Smart Home Monitor</h1>";
  html += "</div>";
  
  html += "<div class='card'>";
  html += "<div class='label'>Temperature</div>";
  html += "<div class='reading'>" + String(temperature, 1) + "¬∞C</div>";
  html += "</div>";
  
  html += "<div class='card'>";
  html += "<div class='label'>Humidity</div>";
  html += "<div class='reading'>" + String(humidity, 1) + "%</div>";
  html += "</div>";
  
  html += "<div class='card'>";
  html += "<h3>LED Control</h3>";
  html += "<a href='/on'><button class='on'>Turn ON</button></a>";
  html += "<a href='/off'><button class='off'>Turn OFF</button></a>";
  html += "</div>";
  
  html += "</body></html>";
  
  server.send(200, "text/html", html);
}

void handleData() {
  // JSON API for future MIT App Inventor integration
  String json = "{";
  json += "\"temperature\":" + String(temperature, 2) + ",";
  json += "\"humidity\":" + String(humidity, 2) + ",";
  json += "\"timestamp\":" + String(millis());
  json += "}";
  
  server.send(200, "application/json", json);
}

void handleOn() {
  digitalWrite(LED, LOW);
  server.send(200, "text/plain", "ON");
}

void handleOff() {
  digitalWrite(LED, HIGH);
  server.send(200, "text/plain", "OFF");
}
